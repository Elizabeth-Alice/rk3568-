<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RK3568 æ™ºèƒ½ç‰©è”ç½‘æ§åˆ¶ä¸­å¿ƒ</title>
    <!-- å¼•å…¥ç°ä»£åŒ– UI æ¡†æ¶ï¼šTailwind CSS + DaisyUI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <!-- å›¾æ ‡åº“ï¼šHeroicons -->
    <script src="https://unpkg.com/heroicons@2.0.18/dist/heroicons.min.js"></script>
    <!-- è§†é¢‘æµæ”¯æŒï¼šHLS.jsï¼ˆç”¨äº mjpeg-streamer å…¼å®¹ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root {
            --primary-color: #1e40af;
            --secondary-color: #1e3a8a;
            --success-color: #22c55e;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #3b82f6 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .sensor-card {
            transition: all 0.3s ease;
        }
        .sensor-card:hover {
            transform: translateY(-4px);
        }
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 */
            height: 0;
            overflow: hidden;
            background: #000;
            border-radius: 1rem;
        }
        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 1rem;
        }
        .status-dot {
            height: 12px;
            width: 12px;
            background-color: #22c55e;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="navbar bg-base-100 shadow-lg sticky top-0 z-50 card-shadow">
        <div class="flex-1">
            <a href="#" class="btn btn-ghost text-xl font-bold text-primary">
                <svg class="w-8 h-8 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
                RK3568 æ™ºèƒ½æ§åˆ¶ä¸­å¿ƒ
            </a>
        </div>
        <div class="flex-none gap-2">
            <div class="indicator">
                <span class="indicator-item badge badge-success"></span>
                <button id="system-status" class="btn btn-ghost btn-circle">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0114 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                </button>
            </div>
            <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-ghost btn-circle avatar">
                    <div class="w-10 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                        <img src="https://ui-avatars.com/api/?name=RK&background=1e40af&color=fff" alt="User" />
                    </div>
</label>
                <ul tabindex="0" class="mt-3 p-2 shadow menu menu-sm dropdown-content bg-base-100 rounded-box w-52">
                    <li><a>ç³»ç»Ÿä¿¡æ¯</a></li>
                    <li><a>æ—¥å¿—æŸ¥çœ‹</a></li>
                    <li><a class="text-error">é€€å‡ºç™»å½•</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container mx-auto p-4 md:p-6 max-w-7xl">

<!-- è®¾å¤‡çŠ¶æ€æ¦‚è§ˆå¡ç‰‡ - ä¼˜åŒ–ä¸º2åˆ—å¸ƒå±€ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="card bg-base-100 card-shadow sensor-card">
                <div class="card-body p-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">æ¸©åº¦</h3>
                            <p class="text-2xl font-bold text-success" id="temperature">-- Â°C</p>
                        </div>
                        <svg class="w-10 h-10 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.485-9.485l-.707.707M5.222 5.222l.707.707m12.364 0l-.707-.707M6.343 17.657l-.707-.707m12.728 0l-.777.777m-14.656 0l-.777-.777"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="card bg-base-100 card-shadow sensor-card">
                <div class="card-body p-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">åœ¨çº¿çŠ¶æ€</h3>
                            <p class="text-lg font-bold flex items-center gap-2">
                                <span class="status-dot"></span>
                                <span class="text-success">å·²è¿æ¥</span>
                            </p>
                        </div>
                        <svg class="w-10 h-10 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- è§†é¢‘æµ + æ§åˆ¶åŒº -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

            <!-- è§†é¢‘æµåŒºåŸŸ -->
            <div class="lg:col-span-2">
                <div class="card bg-base-100 card-shadow">
                    <div class="card-body p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="card-title text-2xl">å®æ—¶è§†é¢‘æµ</h2>
                            <div class="flex gap-2">
                                <button id="snapshot-btn" class="btn btn-success btn-sm">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    æ‹ç…§
                                </button>
                                <button id="record-btn" class="btn btn-error btn-sm">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                    <span id="record-text">å¼€å§‹å½•åƒ</span>
                                </button>
                            </div>
                        </div>
                        <div class="video-container">
                            <video id="video-stream" controls autoplay muted class="rounded-lg"></video>
                            <div id="stream-placeholder" class="flex flex-col items-center justify-center h-full text-gray-400">
                                <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                <p>æ­£åœ¨è¿æ¥è§†é¢‘æµ...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è®¾å¤‡æ§åˆ¶é¢æ¿ -->
            <div>
                <div class="card bg-base-100 card-shadow h-full">
                    <div class="card-body p-6">
                        <h2 class="card-title text-xl mb-4">è®¾å¤‡æ§åˆ¶</h2>

                        <!-- LED æ§åˆ¶ -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <label class="font-medium">LED ç¯</label>
                                <input type="checkbox" id="led-toggle" class="toggle toggle-primary" />
                            </div>
                            <div class="mt-3">
                                <label class="text-sm text-gray-600">äº®åº¦è°ƒèŠ‚</label>
                                <input type="range" min="0" max="100" value="70" id="led-brightness" class="range range-xs range-primary" />
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>0%</span>
                                    <span id="led-value">70%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>

                        <!-- é£æ‰‡æ§åˆ¶ -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <label class="font-medium">é£æ‰‡</label>
                                <input type="checkbox" id="fan-toggle" class="toggle toggle-success" />
                            </div>
                            <div class="mt-3">
                                <label class="text-sm text-gray-600">é£é€Ÿæ§åˆ¶</label>
                                <input type="range" min="0" max="100" value="50" id="fan-speed" class="range range-xs range-success" />
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>åœæ­¢</span>
                                    <span id="fan-value">50%</span>
                                    <span>é«˜é€Ÿ</span>
                                </div>
                            </div>
                            <div class="flex gap-2 mt-3">
                                <button id="fan-forward" class="btn btn-sm btn-outline flex-1">æ­£è½¬</button>
                                <button id="fan-reverse" class="btn btn-sm btn-outline flex-1">åè½¬</button>
                            </div>
                        </div>

                        <!-- èœ‚é¸£å™¨ -->
                        <div>
                            <label class="font-medium">èœ‚é¸£å™¨</label>
                            <button id="buzzer-btn" class="btn btn-warning btn-sm w-full mt-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586m4.707-2.293a1 1 0 00-1.414-1.414l-1.5 1.5m0 0a1 1 0 001.414 1.414l1.5-1.5m-1.5 1.5l-1.5 1.5a1 1 0 001.414-1.414l-1.5-1.5"></path>
                                </svg>
                                è§¦å‘è­¦æŠ¥
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¼ æ„Ÿå™¨æ•°æ®å±•ç¤º - ä¼˜åŒ–ä¸º5åˆ—å¸ƒå±€ -->
        <div class="card bg-base-100 card-shadow mb-6">
            <div class="card-body p-6">
                <h2 class="card-title text-xl mb-4">ä¼ æ„Ÿå™¨å®æ—¶æ•°æ®</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    <!-- æ¸©åº¦ä¼ æ„Ÿå™¨ -->
                    <div class="text-center p-4 bg-base-200 rounded-xl">
                        <div class="text-3xl mb-1" id="sensor1-icon">ğŸŒ¡ï¸</div>
                        <p class="text-sm text-gray-600">æ¸©åº¦</p>
                        <p class="text-xl font-bold" id="sensor1">--</p>
                    </div>
                    <!-- æ¹¿åº¦ä¼ æ„Ÿå™¨ -->
                    <div class="text-center p-4 bg-base-200 rounded-xl">
                        <div class="text-3xl mb-1">ğŸ’§</div>
                        <p class="text-sm text-gray-600">æ¹¿åº¦</p>
                        <p class="text-xl font-bold" id="sensor2">--</p>
                    </div>
                    <!-- çƒ­æ•ä¼ æ„Ÿå™¨ï¼ˆå¯¹åº”ç«ç„°æ£€æµ‹ï¼‰ -->
                    <div class="text-center p-4 bg-base-200 rounded-xl">
                        <div class="text-3xl mb-1">ğŸ”¥</div>
                        <p class="text-sm text-gray-600">çƒ­æ•/ç«ç„°</p>
                        <p class="text-xl font-bold text-success" id="sensor4">æ­£å¸¸</p>
                    </div>
                    <!-- çº¢å¤–ä¼ æ„Ÿå™¨ï¼ˆå¯¹åº”äººä½“æ£€æµ‹ï¼‰ -->
                    <div class="text-center p-4 bg-base-200 rounded-xl">
                        <div class="text-3xl mb-1">ğŸš¶</div>
                        <p class="text-sm text-gray-600">çº¢å¤–/äººä½“</p>
                        <p class="text-xl font-bold text-success" id="sensor5">æœªæ£€æµ‹</p>
                    </div>
                    <!-- å…‰æ•ä¼ æ„Ÿå™¨ï¼ˆå¯¹åº”å…‰ç…§å¼ºåº¦ï¼‰ -->
                    <div class="text-center p-4 bg-base-200 rounded-xl">
                        <div class="text-3xl mb-1">âš¡</div>
                        <p class="text-sm text-gray-600">å…‰æ•/å…‰ç…§</p>
                        <p class="text-xl font-bold" id="sensor6">-- lx</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—ä¸æ“ä½œè®°å½• -->
        <div class="card bg-base-100 card-shadow">
            <div class="card-body p-6">
                <h2 class="card-title text-xl mb-4">æ“ä½œæ—¥å¿—</h2>
                <div class="h-48 overflow-y-auto bg-base-200 rounded-lg p-4 font-mono text-sm" id="log-area">
                    <p class="text-gray-500">ç³»ç»Ÿå¯åŠ¨å®Œæˆï¼Œç­‰å¾…è¿æ¥...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- è„šæœ¬ï¼šè¿æ¥åç«¯ CGI ä¸æ•°æ®æ›´æ–° -->
    <script>
        // å…¨å±€å˜é‡
        const video = document.getElementById('video-stream');
        const placeholder = document.getElementById('stream-placeholder');
        const recordBtn = document.getElementById('record-btn');
        const recordText = document.getElementById('record-text');
        let isRecording = false;
        let streamSource = null;

        // 1. æ‹ç…§æŒ‰é’®äº‹ä»¶ç»‘å®š
        document.getElementById('snapshot-btn').addEventListener('click', () => {
            takeSnapshot();
        });

        // æ›´æ–°è®¾å¤‡çŠ¶æ€æ•°æ®
        function updateDeviceStatus() {
            fetch('/api/device_state')
                .then(response => response.json())
                .then(data => {
                    // æ›´æ–°æ¸©åº¦æ˜¾ç¤º
                    document.getElementById('temperature').textContent = data.temperature.toFixed(1) + ' Â°C';
                    document.getElementById('sensor1').textContent = data.temperature.toFixed(1);
                    
                    // æ›´æ–°æ¹¿åº¦æ˜¾ç¤º
                    document.getElementById('sensor2').textContent = data.humidity.toFixed(1);
                    
                    // æ›´æ–°LEDçŠ¶æ€
                    const ledToggle = document.getElementById('led-toggle');
                    const ledValue = document.getElementById('led-value');
                    ledToggle.checked = data.led_state === 1;
                    ledValue.textContent = data.led_brightness + '%';
                    document.getElementById('led-brightness').value = data.led_brightness;
                    
                    // æ›´æ–°é£æ‰‡çŠ¶æ€
                    const fanToggle = document.getElementById('fan-toggle');
                    const fanValue = document.getElementById('fan-value');
                    fanToggle.checked = data.fan_state === 1;
                    fanValue.textContent = data.fan_speed + '%';
                    document.getElementById('fan-speed').value = data.fan_speed;
                    
                    // æ›´æ–°é£æ‰‡æ–¹å‘æŒ‰é’®çŠ¶æ€
                    const fanForward = document.getElementById('fan-forward');
                    const fanReverse = document.getElementById('fan-reverse');
                    if (data.fan_dir === 0) {
                        fanForward.classList.add('btn-primary');
                        fanReverse.classList.remove('btn-primary');
                    } else {
                        fanForward.classList.remove('btn-primary');
                        fanReverse.classList.add('btn-primary');
                    }
                    
                    // æ›´æ–°çƒ­æ•ä¼ æ„Ÿå™¨æ•°æ®ï¼ˆå¯¹åº”ç«ç„°æ£€æµ‹ï¼‰
                    const thermistorElement = document.getElementById('sensor4');
                    if (data.thermistor_value > 50) { // å‡è®¾é˜ˆå€¼50ä»¥ä¸Šä¸ºå¼‚å¸¸
                        thermistorElement.textContent = 'å¼‚å¸¸é«˜æ¸©';
                        thermistorElement.className = 'text-xl font-bold text-error';
                    } else {
                        thermistorElement.textContent = 'æ­£å¸¸';
                        thermistorElement.className = 'text-xl font-bold text-success';
                    }
                    
                    // æ›´æ–°çº¢å¤–ä¼ æ„Ÿå™¨æ•°æ®ï¼ˆå¯¹åº”äººä½“æ£€æµ‹ï¼‰
                    const infraredElement = document.getElementById('sensor5');
                    if (data.infrared_state === 1) {
                        infraredElement.textContent = 'æ£€æµ‹åˆ°äººä½“';
                        infraredElement.className = 'text-xl font-bold text-error';
                    } else {
                        infraredElement.textContent = 'æœªæ£€æµ‹';
                        infraredElement.className = 'text-xl font-bold text-success';
                    }
                    
                    // æ›´æ–°å…‰æ•ä¼ æ„Ÿå™¨æ•°æ®ï¼ˆå¯¹åº”å…‰ç…§å¼ºåº¦ï¼‰
                    const lightElement = document.getElementById('sensor6');
                    lightElement.textContent = data.light_intensity + ' lx';
                    
                    // æ·»åŠ æ—¥å¿—
                    addLog(`ğŸ“Š æ•°æ®æ›´æ–°: æ¸©åº¦${data.temperature.toFixed(1)}Â°C æ¹¿åº¦${data.humidity.toFixed(1)}% LED${data.led_state} é£æ‰‡${data.fan_state} çº¢å¤–${data.infrared_state} å…‰ç…§${data.light_intensity} çƒ­æ•${data.thermistor_value}`);
                })
                .catch(error => {
                    console.error('è·å–è®¾å¤‡çŠ¶æ€å¤±è´¥:', error);
                    addLog('âŒ è·å–è®¾å¤‡çŠ¶æ€å¤±è´¥');
                });
        }

        // æ·»åŠ æ—¥å¿—å‡½æ•°
        function addLog(message) {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('p');
            logEntry.innerHTML = `<span class="text-gray-400">[${timestamp}]</span> ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // 1. åˆå§‹åŒ–è§†é¢‘æµ (mjpeg-streamer ç¤ºä¾‹)
        // åˆå§‹åŒ–è§†é¢‘æµ
        function initVideoStream() {
                // ç›´æ¥è®¿é—®8081ç«¯å£çš„è§†é¢‘æµæœåŠ¡ï¼Œä¸å†é€šè¿‡8080ç«¯å£ä»£ç†
                const streamUrl = 'http://' + window.location.hostname + ':8081/?action=stream';
                // æ”¾å¼ƒHLSï¼Œç›´æ¥ç”¨MJPEGï¼ˆmjpeg-streameråŸç”Ÿæµï¼‰
                // æ³¨æ„ï¼šMJPEGåœ¨videoæ ‡ç­¾å…¼å®¹æ€§å·®ï¼Œæ”¹ç”¨imgæ ‡ç­¾æ›´ç¨³å®š
                const videoContainer = document.querySelector('.video-container');
                // éšè—åŸvideoæ ‡ç­¾ï¼Œæ”¹ç”¨imgåŠ è½½MJPEGæµ
                video.style.display = 'none';
                const mjpegImg = document.createElement('img');
                mjpegImg.src = streamUrl;
                mjpegImg.style.cssText =
                    'position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; border-radius: 1rem;';
                mjpegImg.onload = () => {
                    placeholder.style.display = 'none';
                };
                mjpegImg.onerror = () => {
                    addLog('âŒ è§†é¢‘æµåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨');
                };
                videoContainer.appendChild(mjpegImg);
            }
        
        // æ‹ç…§åŠŸèƒ½
        function takeSnapshot() {
            // ä½¿ç”¨æ–°çš„ /api/snapshot API
            const snapshotUrl = '/api/snapshot';
            
            fetch(snapshotUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.blob();
                })
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'snapshot_' + new Date().toISOString().replace(/[:.]/g, '-') + '.jpg';
                    a.click();
                    URL.revokeObjectURL(url);
                    addLog("ğŸ“¸ æ‹ç…§æˆåŠŸï¼Œå›¾ç‰‡å·²ä¸‹è½½");
                })
                .catch(error => {
                    console.error("æ‹ç…§å¤±è´¥:", error);
                    addLog("âŒ æ‹ç…§å¤±è´¥: " + error.message);
                });
        }

        // 3. å½•åƒæ§åˆ¶ï¼ˆéœ€è¦åç«¯æ”¯æŒï¼‰
        recordBtn.addEventListener('click', () => {
            if (!isRecording) {
                // å¼€å§‹å½•åƒé€»è¾‘
                addLog('ğŸ¥ å¼€å§‹å½•åƒï¼ˆåŠŸèƒ½å¾…å®ç°ï¼‰');
                recordBtn.classList.remove('btn-error');
                recordBtn.classList.add('btn-success');
                recordText.textContent = 'åœæ­¢å½•åƒ';
                isRecording = true;
            } else {
                // åœæ­¢å½•åƒé€»è¾‘
                addLog('â¹ï¸ åœæ­¢å½•åƒï¼ˆåŠŸèƒ½å¾…å®ç°ï¼‰');
                recordBtn.classList.remove('btn-success');
                recordBtn.classList.add('btn-error');
                recordText.textContent = 'å¼€å§‹å½•åƒ';
                isRecording = false;
            }
        });

        // 4. LEDæ§åˆ¶
        document.getElementById('led-toggle').addEventListener('change', (e) => {
            const state = e.target.checked ? 1 : 0;
            const brightness = document.getElementById('led-brightness').value;
            
            // è°ƒç”¨LEDæ§åˆ¶API
            fetch(`/api/led_control?state=${state}&brightness=${brightness}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        addLog(`ğŸ’¡ LED ${state ? 'å¼€å¯' : 'å…³é—­'}`);
                    } else {
                        addLog(`âŒ LEDæ§åˆ¶å¤±è´¥: ${data.message}`);
                        // æ¢å¤å¼€å…³çŠ¶æ€
                        e.target.checked = !state;
                    }
                })
                .catch(error => {
                    console.error('LEDæ§åˆ¶APIè°ƒç”¨å¤±è´¥:', error);
                    addLog('âŒ LEDæ§åˆ¶APIè°ƒç”¨å¤±è´¥');
                    // æ¢å¤å¼€å…³çŠ¶æ€
                    e.target.checked = !state;
                });
        });

        document.getElementById('led-brightness').addEventListener('input', (e) => {
            const brightness = e.target.value;
            document.getElementById('led-value').textContent = brightness + '%';
            
            // åªæœ‰å½“LEDå¼€å¯æ—¶æ‰å‘é€äº®åº¦æ§åˆ¶å‘½ä»¤
            const ledToggle = document.getElementById('led-toggle');
            if (ledToggle.checked) {
                // è°ƒç”¨LEDæ§åˆ¶API
                fetch(`/api/led_control?brightness=${brightness}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            addLog(`ğŸ’¡ LEDäº®åº¦è°ƒæ•´ä¸º ${brightness}%`);
                        } else {
                            addLog(`âŒ LEDäº®åº¦æ§åˆ¶å¤±è´¥: ${data.message}`);
                        }
                    })
                    .catch(error => {
                        console.error('LEDäº®åº¦æ§åˆ¶APIè°ƒç”¨å¤±è´¥:', error);
                        addLog('âŒ LEDäº®åº¦æ§åˆ¶APIè°ƒç”¨å¤±è´¥');
                    });
            } else {
                addLog(`ğŸ’¡ LEDäº®åº¦è°ƒæ•´ä¸º ${brightness}% (LEDæœªå¼€å¯)`);
            }
        });

        // 5. é£æ‰‡æ§åˆ¶
        document.getElementById('fan-toggle').addEventListener('change', (e) => {
            const state = e.target.checked ? 1 : 0;
            const speed = document.getElementById('fan-speed').value;
            const direction = document.getElementById('fan-forward').classList.contains('btn-primary') ? 0 : 1;
            
            // è°ƒç”¨é£æ‰‡æ§åˆ¶API
            fetch(`/api/fan_control?state=${state}&speed=${speed}&direction=${direction}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        addLog(`ğŸ’¨ é£æ‰‡ ${state ? 'å¼€å¯' : 'å…³é—­'}`);
                    } else {
                        addLog(`âŒ é£æ‰‡æ§åˆ¶å¤±è´¥: ${data.message}`);
                        // æ¢å¤å¼€å…³çŠ¶æ€
                        e.target.checked = !state;
                    }
                })
                .catch(error => {
                    console.error('é£æ‰‡æ§åˆ¶APIè°ƒç”¨å¤±è´¥:', error);
                    addLog('âŒ é£æ‰‡æ§åˆ¶APIè°ƒç”¨å¤±è´¥');
                    // æ¢å¤å¼€å…³çŠ¶æ€
                    e.target.checked = !state;
                });
        });

        document.getElementById('fan-speed').addEventListener('input', (e) => {
            const speed = e.target.value;
            document.getElementById('fan-value').textContent = speed + '%';
            
            // åªæœ‰å½“é£æ‰‡å¼€å¯æ—¶æ‰å‘é€é€Ÿåº¦æ§åˆ¶å‘½ä»¤
            const fanToggle = document.getElementById('fan-toggle');
            if (fanToggle.checked) {
                const direction = document.getElementById('fan-forward').classList.contains('btn-primary') ? 0 : 1;
                
                // è°ƒç”¨é£æ‰‡æ§åˆ¶API
                fetch(`/api/fan_control?speed=${speed}&direction=${direction}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            addLog(`ğŸ’¨ é£æ‰‡é€Ÿåº¦è°ƒæ•´ä¸º ${speed}%`);
                        } else {
                            addLog(`âŒ é£æ‰‡é€Ÿåº¦æ§åˆ¶å¤±è´¥: ${data.message}`);
                        }
                    })
                    .catch(error => {
                        console.error('é£æ‰‡é€Ÿåº¦æ§åˆ¶APIè°ƒç”¨å¤±è´¥:', error);
                        addLog('âŒ é£æ‰‡é€Ÿåº¦æ§åˆ¶APIè°ƒç”¨å¤±è´¥');
                    });
            } else {
                addLog(`ğŸ’¨ é£æ‰‡é€Ÿåº¦è°ƒæ•´ä¸º ${speed}% (é£æ‰‡æœªå¼€å¯)`);
            }
        });

        document.getElementById('fan-forward').addEventListener('click', () => {
            // åªæœ‰å½“é£æ‰‡å¼€å¯æ—¶æ‰å‘é€æ–¹å‘æ§åˆ¶å‘½ä»¤
            const fanToggle = document.getElementById('fan-toggle');
            if (fanToggle.checked) {
                const speed = document.getElementById('fan-speed').value;
                
                // è°ƒç”¨é£æ‰‡æ§åˆ¶API
                fetch(`/api/fan_control?direction=0&speed=${speed}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            addLog('ğŸ’¨ é£æ‰‡è®¾ç½®ä¸ºæ­£è½¬');
                            // æ›´æ–°æŒ‰é’®çŠ¶æ€
                            document.getElementById('fan-forward').classList.add('btn-primary');
                            document.getElementById('fan-reverse').classList.remove('btn-primary');
                        } else {
                            addLog(`âŒ é£æ‰‡æ–¹å‘æ§åˆ¶å¤±è´¥: ${data.message}`);
                        }
                    })
                    .catch(error => {
                        console.error('é£æ‰‡æ–¹å‘æ§åˆ¶APIè°ƒç”¨å¤±è´¥:', error);
                        addLog('âŒ é£æ‰‡æ–¹å‘æ§åˆ¶APIè°ƒç”¨å¤±è´¥');
                    });
            } else {
                addLog('ğŸ’¨ é£æ‰‡è®¾ç½®ä¸ºæ­£è½¬ (é£æ‰‡æœªå¼€å¯)');
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('fan-forward').classList.add('btn-primary');
                document.getElementById('fan-reverse').classList.remove('btn-primary');
            }
        });

        document.getElementById('fan-reverse').addEventListener('click', () => {
            // åªæœ‰å½“é£æ‰‡å¼€å¯æ—¶æ‰å‘é€æ–¹å‘æ§åˆ¶å‘½ä»¤
            const fanToggle = document.getElementById('fan-toggle');
            if (fanToggle.checked) {
                const speed = document.getElementById('fan-speed').value;
                
                // è°ƒç”¨é£æ‰‡æ§åˆ¶API
                fetch(`/api/fan_control?direction=1&speed=${speed}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            addLog('ğŸ’¨ é£æ‰‡è®¾ç½®ä¸ºåè½¬');
                            // æ›´æ–°æŒ‰é’®çŠ¶æ€
                            document.getElementById('fan-forward').classList.remove('btn-primary');
                            document.getElementById('fan-reverse').classList.add('btn-primary');
                        } else {
                            addLog(`âŒ é£æ‰‡æ–¹å‘æ§åˆ¶å¤±è´¥: ${data.message}`);
                        }
                    })
                    .catch(error => {
                        console.error('é£æ‰‡æ–¹å‘æ§åˆ¶APIè°ƒç”¨å¤±è´¥:', error);
                        addLog('âŒ é£æ‰‡æ–¹å‘æ§åˆ¶APIè°ƒç”¨å¤±è´¥');
                    });
            } else {
                addLog('ğŸ’¨ é£æ‰‡è®¾ç½®ä¸ºåè½¬ (é£æ‰‡æœªå¼€å¯)');
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('fan-forward').classList.remove('btn-primary');
                document.getElementById('fan-reverse').classList.add('btn-primary');
            }
        });

        // 6. èœ‚é¸£å™¨æ§åˆ¶
        document.getElementById('buzzer-btn').addEventListener('click', () => {
            addLog('ğŸ”Š è§¦å‘èœ‚é¸£å™¨è­¦æŠ¥');
            // è¿™é‡Œå¯ä»¥æ·»åŠ æ§åˆ¶èœ‚é¸£å™¨çš„APIè°ƒç”¨
        });

        // 7. å®šæ—¶æ›´æ–°è®¾å¤‡çŠ¶æ€ï¼ˆæ¯ç§’æ›´æ–°ï¼‰
        setInterval(updateDeviceStatus, 1000);

        // 8. é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            addLog('ğŸŒ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è¿æ¥è®¾å¤‡...');
            updateDeviceStatus(); // ç«‹å³æ›´æ–°ä¸€æ¬¡çŠ¶æ€
            initVideoStream(); // å¯åŠ¨è§†é¢‘æµè¿æ¥
        });
    </script>
</body>
</html>